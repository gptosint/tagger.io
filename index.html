<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Tagger.io — quick image and map tagging" />
  <title>Tagger.io — Map & Image Tagger</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    :root{--accent:#0d6efd;--bg:#f8f9fa;--text:#222;--muted:#6c757d}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:var(--bg)}
    .container{max-width:1100px;margin:16px auto;padding:0 16px}
    header.site-header{background:white;border-bottom:1px solid #e9ecef}
    header .inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .site-title{margin:0;font-size:1.25rem}
    .site-subtitle{color:var(--muted);font-size:.9rem}

    main.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;min-height:70vh;padding:16px 0}
    .panel{background:white;border:1px solid #e9ecef;padding:12px;border-radius:8px}
    #map{width:100%;height:75vh;border-radius:8px;overflow:hidden}

    .controls{display:flex;flex-direction:column;gap:8px}
    .controls .row{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:6px;border:1px solid #ced4da;background:white;cursor:pointer}
    .btn.primary{background:var(--accent);color:white;border-color:transparent}

    .tags-list{list-style:none;padding:0;margin:8px 0;display:flex;flex-direction:column;gap:6px}
    .tag-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid #e9ecef;border-radius:6px}
    .tag-meta{font-size:.85rem;color:var(--muted)}

    .no-js-warning{background:#fff3cd;color:#856404;padding:8px;border-radius:6px;margin:12px;text-align:center}

    /* popup input for tagging */
    .tag-popup{position:absolute;background:white;border:1px solid #ddd;padding:8px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.12);z-index:1000}
    .tag-popup input{padding:6px;border:1px solid #ced4da;border-radius:6px;width:200px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container inner">
      <div>
        <h1 class="site-title">Tagger.io</h1>
        <div class="site-subtitle">Tag places on the globe and export your tags</div>
      </div>
      <div>
        <small class="site-subtitle">Map powered by Mapbox GL JS</small>
      </div>
    </div>
  </header>

  <main class="container grid">
    <section class="panel">
      <div id="map" title="Map - click to add a tag"></div>
    </section>

    <aside class="panel">
      <h2 style="margin:0 0 8px 0">Tags</h2>
      <div class="controls">
        <div class="row">
          <button id="enable-add" class="btn primary">Enable Add Mode</button>
          <button id="disable-add" class="btn">Disable</button>
        </div>
        <div class="row">
          <button id="download-json" class="btn">Download JSON</button>
          <button id="clear-tags" class="btn">Clear Tags</button>
        </div>
        <div style="font-size:.85rem;color:var(--muted);">Click on the globe to drop a tag while Add Mode is enabled. Use the list to manage tags.</div>

        <ul id="tags-list" class="tags-list" aria-live="polite"></ul>
      </div>
    </aside>
  </main>

  <footer class="container" style="padding:12px 16px;text-align:center;color:var(--muted)">
    <small>© Tagger.io — Map tagging demo</small>
  </footer>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>

  <script type="module">
    // Mapbox token: replace with your token or set MAPBOX_ACCESS_TOKEN before serving
    const MAPBOX_TOKEN = (window.MAPBOX_ACCESS_TOKEN || 'YOUR_MAPBOX_ACCESS_TOKEN');
    if (!MAPBOX_TOKEN || MAPBOX_TOKEN === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      console.warn('Mapbox access token not set. Replace YOUR_MAPBOX_ACCESS_TOKEN with a valid token.');
    }

    mapboxgl.accessToken = MAPBOX_TOKEN;

    // Initialize map with globe projection and sensible default
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v11',
      center: [0, 20],
      zoom: 1.5,
      projection: 'globe', // enable globe
      pitch: 0
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl());

    // Add atmosphere/fog for globe effect when style loads
    map.on('style.load', () => {
      // Enable globe atmosphere (Mapbox GL JS >= 2.0)
      if (map.setFog) {
        map.setFog({
          'range': [-1, 2],
          'color': 'rgba(255,255,255,0.02)',
          'high-color': 'rgba(255,255,255,0.15)'
        });
      }
    });

    // Tagging state
    let addMode = false;
    const enableBtn = document.getElementById('enable-add');
    const disableBtn = document.getElementById('disable-add');
    const tagsListEl = document.getElementById('tags-list');
    const downloadBtn = document.getElementById('download-json');
    const clearBtn = document.getElementById('clear-tags');

    const tags = [];
    const markers = new Map();

    function renderTags() {
      tagsListEl.innerHTML = '';
      tags.forEach((t) => {
        const li = document.createElement('li');
        li.className = 'tag-item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${escapeHtml(t.label)}</strong><div class="tag-meta">${t.lng.toFixed(5)}, ${t.lat.toFixed(5)}</div>`;
        const actions = document.createElement('div');
        const btnDel = document.createElement('button');
        btnDel.className = 'btn';
        btnDel.textContent = 'Delete';
        btnDel.addEventListener('click', () => removeTag(t.id));
        const btnZoom = document.createElement('button');
        btnZoom.className = 'btn';
        btnZoom.style.marginLeft = '8px';
        btnZoom.textContent = 'Zoom';
        btnZoom.addEventListener('click', () => {
          map.easeTo({ center: [t.lng, t.lat], zoom: 6, pitch: 45 });
        });
        actions.appendChild(btnZoom);
        actions.appendChild(btnDel);
        li.appendChild(left);
        li.appendChild(actions);
        tagsListEl.appendChild(li);
      });
    }

    function addTag(lngLat, label) {
      const id = 'tag-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
      const t = { id, lng: lngLat.lng, lat: lngLat.lat, label: label || 'Tag' };
      tags.push(t);

      // Create a marker with a small popup
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.width = '26px';
      el.style.height = '26px';
      el.style.borderRadius = '50%';
      el.style.background = 'rgba(13,110,253,0.9)';
      el.style.border = '2px solid white';
      el.style.boxShadow = '0 1px 4px rgba(0,0,0,0.4)';
      el.title = label;

      const marker = new mapboxgl.Marker({ element: el }).setLngLat([t.lng, t.lat]).addTo(map);

      const popup = new mapboxgl.Popup({ offset: 12, closeButton: false }).setHTML(`<strong>${escapeHtml(t.label)}</strong><div class="tag-meta">${t.lng.toFixed(5)}, ${t.lat.toFixed(5)}</div>`);
      marker.setPopup(popup);

      markers.set(t.id, marker);
      renderTags();
    }

    function removeTag(id) {
      const idx = tags.findIndex(x => x.id === id);
      if (idx !== -1) {
        tags.splice(idx, 1);
      }
      const m = markers.get(id);
      if (m) {
        m.remove();
        markers.delete(id);
      }
      renderTags();
    }

    function clearAllTags() {
      tags.slice().forEach(t => removeTag(t.id));
    }

    // map click handler to add tag
    map.on('click', (e) => {
      if (!addMode) return;
      const lngLat = e.lngLat;

      // Show a small floating input near the click location on the map container
      showTagPopup(e.point, lngLat);
    });

    function showTagPopup(point, lngLat) {
      // remove any existing popup input
      const existing = document.querySelector('.tag-popup');
      if (existing) existing.remove();

      const popup = document.createElement('div');
      popup.className = 'tag-popup';
      popup.style.left = Math.min(point.x, window.innerWidth - 260) + 'px';
      popup.style.top = Math.max(point.y - 10, 10) + 'px';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Enter tag label';
      popup.appendChild(input);

      const btnOk = document.createElement('button');
      btnOk.className = 'btn primary';
      btnOk.style.marginLeft = '8px';
      btnOk.textContent = 'Add';
      btnOk.addEventListener('click', () => {
        const label = input.value.trim() || 'Tag';
        addTag(lngLat, label);
        popup.remove();
      });

      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn';
      btnCancel.style.marginLeft = '8px';
      btnCancel.textContent = 'Cancel';
      btnCancel.addEventListener('click', () => popup.remove());

      popup.appendChild(btnOk);
      popup.appendChild(btnCancel);

      document.body.appendChild(popup);
      input.focus();

      // close when clicking outside
      function onDoc(e) {
        if (!popup.contains(e.target)) {
          popup.remove();
          document.removeEventListener('mousedown', onDoc);
        }
      }
      document.addEventListener('mousedown', onDoc);
    }

    enableBtn.addEventListener('click', () => {
      addMode = true;
      enableBtn.disabled = true;
      disableBtn.disabled = false;
      enableBtn.textContent = 'Add Mode: ON';
    });
    disableBtn.addEventListener('click', () => {
      addMode = false;
      enableBtn.disabled = false;
      disableBtn.disabled = true;
      enableBtn.textContent = 'Enable Add Mode';
      // remove any popup input
      const p = document.querySelector('.tag-popup'); if (p) p.remove();
    });

    // initialize buttons state
    disableBtn.disabled = true;

    downloadBtn.addEventListener('click', () => {
      const payload = { created_at: new Date().toISOString(), tags: tags.slice() };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'map-tags.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    clearBtn.addEventListener('click', () => {
      if (!confirm('Clear all tags?')) return;
      clearAllTags();
    });

    // simple HTML escaping
    function escapeHtml(s){ return String(s).replace(/[&<>\